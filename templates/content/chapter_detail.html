{% extends "base.html" %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('content.index') }}">Chapters</a></li>
        <li class="breadcrumb-item active">{{ chapter.title }}</li>
    </ol>
</nav>

<div class="progress mb-4">
    <div class="progress-bar" role="progressbar" style="width: 0%;" 
         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
</div>

<h2>{{ chapter.title }}</h2>
<p class="lead">{{ chapter.description }}</p>

{% for subchapter in chapter.subchapters %}
<div class="card mb-4 subchapter-card" data-subchapter-id="{{ subchapter.id }}">
    <div class="card-header">
        <h4 class="mb-0 d-flex align-items-center">
            {{ subchapter.title }}
            <span class="ms-auto completion-status">
                <i class="fas fa-check-circle text-success d-none"></i>
            </span>
        </h4>
    </div>
    <div class="card-body">
        {% for content in subchapter.contents %}
        <div class="content-item mb-4">
            {% if content.content_type == 'text' %}
                {{ content.content|safe }}
            {% elif content.content_type == 'video' %}
                <div class="ratio ratio-16x9">
                    <iframe src="{{ content.content }}" allowfullscreen></iframe>
                </div>
            {% elif content.content_type == 'link' %}
                <a href="{{ content.content }}" target="_blank" class="btn btn-info">
                    <i class="fas fa-external-link-alt"></i> External Resource
                </a>
            {% endif %}
        </div>
        {% endfor %}

        <div class="navigation-buttons text-center mt-4">
            {% if not loop.first %}
            <button class="btn btn-secondary btn-back">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            {% endif %}

            <button class="btn btn-primary btn-next" data-subchapter-id="{{ subchapter.id }}">
                {% if loop.last %}
                    Finish <i class="fas fa-flag-checkered"></i>
                {% else %}
                    Next <i class="fas fa-arrow-right"></i>
                {% endif %}
            </button>
        </div>
    </div>
</div>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load progress
    fetch(`/progress/status/{{ chapter.id }}`)
        .then(response => response.json())
        .then(data => {
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = data.percentage + '%';
            progressBar.textContent = data.percentage + '%';
            progressBar.setAttribute('aria-valuenow', data.percentage);

            // Mark completed subchapters
            if (data.completed > 0) {
                document.querySelectorAll('.subchapter-card').forEach((card, index) => {
                    if (index < data.completed) {
                        card.querySelector('.completion-status i').classList.remove('d-none');
                    }
                });
            }
        });

    // Handle navigation
    document.querySelectorAll('.btn-next').forEach(button => {
        button.addEventListener('click', function() {
            const subchapterId = this.dataset.subchapterId;
            fetch(`/progress/${subchapterId}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    // Update progress bar
                    fetch(`/progress/status/{{ chapter.id }}`)
                        .then(response => response.json())
                        .then(progressData => {
                            const progressBar = document.querySelector('.progress-bar');
                            progressBar.style.width = progressData.percentage + '%';
                            progressBar.textContent = progressData.percentage + '%';
                            progressBar.setAttribute('aria-valuenow', progressData.percentage);
                        });
                }
            });
        });
    });

    // Handle back button
    document.querySelectorAll('.btn-back').forEach(button => {
        button.addEventListener('click', function() {
            const currentCard = this.closest('.subchapter-card');
            const prevCard = currentCard.previousElementSibling;
            if (prevCard) {
                currentCard.classList.add('d-none');
                prevCard.classList.remove('d-none');
            }
        });
    });
});
</script>
{% endblock %}